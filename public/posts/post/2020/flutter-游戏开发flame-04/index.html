<!DOCTYPE html>
<html lang="zh-CN"
  x-data
  :class="$store.darkMode.class()"
  :data-theme="$store.darkMode.theme()">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flutter 游戏开发(flame) 04 分数, 存档和音效(4/5) | 阿航的技术小站</title>

    

<link rel="canonical" href="http://localhost:1313/posts/post/2020/flutter-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91flame-04/" />



<meta name="author" content="" />
<meta name="description" content="引言 分数和高分记录是任何游戏中不可或缺的一部分. 有些游戏根据收集的金币数量计算得分, 有些基于杀敌数, 有些则基于存活时间.
同样不能忽视音效和BGM(背景音乐). 加上它们, 游戏将会蜕变🦋.
如果一个游戏无声, 它就是不完整的.
欢迎来到Flutter&#43;Flame系列的第四章. 如果你还没有读过之前的章节, 建议你先阅读一下哦!🤭
🔴 注意: 本教程的背景音乐有些过时. 你可以先学本章教程, 之后再替换为这篇教程 下面是我们本系列教程的文章目录:
Flutter 游戏开发(flame) Flame介绍 Flutter 游戏开发(flame) 01 开发2D休闲游戏：消灭小飞蝇(1/5) Flutter 游戏开发(flame) 02 图形和动画(2/5) Flutter 游戏开发(flame) 03 界面和弹窗(3/5) Flutter 游戏开发(flame) 04 分数, 存档和音效(4/5) 本章 Flutter 游戏开发(flame) 05 收尾和打包(5/5) 需具备的条件 本系列教程之前的全部要求👈 更多的资源包 – 本教程提供了资源包, 但你也可以使用自己的. 推荐资源网站Open Game Art . 音效和音乐资源 - 这些也可以在游戏资源网站上找到, 比如Open Game Art . 还有专门的音频资源比如BenSound.com . 同样, 你必须查看许可并在游戏中表示感谢. 我们将使用与前一部分相同的编码规范👩‍🏫
👉在Github 或码云 上查看本章全部代码
新的资源包 这一部分中, 我们需要另一个资源包, 包含额外的图形、背景音乐和一些音效.
" />


<meta name="keywords" content="Flame,Flutter,游戏开发">



<meta name="generator" content="Hugo 0.145.0">


<meta property="og:url" content="http://localhost:1313/posts/post/2020/flutter-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91flame-04/">
  <meta property="og:site_name" content="阿航的技术小站">
  <meta property="og:title" content="Flutter 游戏开发(flame) 04 分数, 存档和音效(4/5)">
  <meta property="og:description" content="引言 分数和高分记录是任何游戏中不可或缺的一部分. 有些游戏根据收集的金币数量计算得分, 有些基于杀敌数, 有些则基于存活时间.
同样不能忽视音效和BGM(背景音乐). 加上它们, 游戏将会蜕变🦋.
如果一个游戏无声, 它就是不完整的.
欢迎来到Flutter&#43;Flame系列的第四章. 如果你还没有读过之前的章节, 建议你先阅读一下哦!🤭
🔴 注意: 本教程的背景音乐有些过时. 你可以先学本章教程, 之后再替换为这篇教程 下面是我们本系列教程的文章目录:
Flutter 游戏开发(flame) Flame介绍 Flutter 游戏开发(flame) 01 开发2D休闲游戏：消灭小飞蝇(1/5) Flutter 游戏开发(flame) 02 图形和动画(2/5) Flutter 游戏开发(flame) 03 界面和弹窗(3/5) Flutter 游戏开发(flame) 04 分数, 存档和音效(4/5) 本章 Flutter 游戏开发(flame) 05 收尾和打包(5/5) 需具备的条件 本系列教程之前的全部要求👈 更多的资源包 – 本教程提供了资源包, 但你也可以使用自己的. 推荐资源网站Open Game Art . 音效和音乐资源 - 这些也可以在游戏资源网站上找到, 比如Open Game Art . 还有专门的音频资源比如BenSound.com . 同样, 你必须查看许可并在游戏中表示感谢. 我们将使用与前一部分相同的编码规范👩‍🏫
👉在Github 或码云 上查看本章全部代码
新的资源包 这一部分中, 我们需要另一个资源包, 包含额外的图形、背景音乐和一些音效.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-04-17T00:00:00+00:00">
    <meta property="article:modified_time" content="2020-04-17T00:00:00+00:00">
    <meta property="article:tag" content="Flame">
    <meta property="article:tag" content="Flutter">
    <meta property="article:tag" content="游戏开发">




  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Flutter 游戏开发(flame) 04 分数, 存档和音效(4/5)">
  <meta name="twitter:description" content="引言 分数和高分记录是任何游戏中不可或缺的一部分. 有些游戏根据收集的金币数量计算得分, 有些基于杀敌数, 有些则基于存活时间.
同样不能忽视音效和BGM(背景音乐). 加上它们, 游戏将会蜕变🦋.
如果一个游戏无声, 它就是不完整的.
欢迎来到Flutter&#43;Flame系列的第四章. 如果你还没有读过之前的章节, 建议你先阅读一下哦!🤭
🔴 注意: 本教程的背景音乐有些过时. 你可以先学本章教程, 之后再替换为这篇教程 下面是我们本系列教程的文章目录:
Flutter 游戏开发(flame) Flame介绍 Flutter 游戏开发(flame) 01 开发2D休闲游戏：消灭小飞蝇(1/5) Flutter 游戏开发(flame) 02 图形和动画(2/5) Flutter 游戏开发(flame) 03 界面和弹窗(3/5) Flutter 游戏开发(flame) 04 分数, 存档和音效(4/5) 本章 Flutter 游戏开发(flame) 05 收尾和打包(5/5) 需具备的条件 本系列教程之前的全部要求👈 更多的资源包 – 本教程提供了资源包, 但你也可以使用自己的. 推荐资源网站Open Game Art . 音效和音乐资源 - 这些也可以在游戏资源网站上找到, 比如Open Game Art . 还有专门的音频资源比如BenSound.com . 同样, 你必须查看许可并在游戏中表示感谢. 我们将使用与前一部分相同的编码规范👩‍🏫
👉在Github 或码云 上查看本章全部代码
新的资源包 这一部分中, 我们需要另一个资源包, 包含额外的图形、背景音乐和一些音效.">




<link rel="stylesheet" href="/css/output.css" />




    


<style>
  pre {
    padding: 1em;
    overflow: auto;
  }
</style>









    

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>

  <body x-data="{
    flip: false,
  }">
    
    <div id="dream-global-bg"></div>

    
<nav class="mt-4 lg:mt-8 py-4">

  
  <div class="container flex justify-between px-4">
  
    <section class="flex items-center gap-4">
      <div class="avatar cursor-pointer hover:online" @click="flip = !flip" title="Flip it!">
        <div class="h-10 rounded-full">
          <img src="/" alt="" />
        </div>
      </div>

      
    </section>

    <div class="dropdown dropdown-end sm:hidden">
      <div tabindex="0" role="button" class="btn btn-ghost btn-square" aria-label="Select an option">
        <ion-icon name="menu" class="text-2xl"></ion-icon>
      </div>
      <ul tabindex="0" class="dropdown-content menu w-36 bg-base-100 rounded-box z-[1] shadow-md">
        

















<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/posts" title="Archives">
    <ion-icon name="archive"></ion-icon>
    Archives
  </a>
</li>




<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/categories" title="All Categories">
    <ion-icon name="grid"></ion-icon>
    All Categories
  </a>
</li>




<li>
  <a class="inline-flex items-center p-2 cursor-pointer" href="/tags" title="All Tags">
    <ion-icon name="pricetags"></ion-icon>
    All Tags
  </a>
</li>






      </ul>
    </div>
    <section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4">
      
      

      

      
      





      
      





      
      





      
      
<a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/posts" title="Archives">
  <ion-icon class="group-hover:text-primary-content" name="archive"></ion-icon>
</a>


      
      
<a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/categories" title="All Categories">
  <ion-icon class="group-hover:text-primary-content" name="grid"></ion-icon>
</a>


      
      
<a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="/tags" title="All Tags">
  <ion-icon class="group-hover:text-primary-content" name="pricetags"></ion-icon>
</a>


      

      

      
    </section>
  </div>
</nav>


    <div class="flip-container" :class="{ 'flip-it': flip }">
      <div class="flipper">
        <div class="front">
          <div class="container">
            
<div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4">
  <div class="hidden lg:block">
    
  </div>

  <div class="lg:col-span-2">
    <article class="mx-auto prose prose-quoteless dark:prose-invert" id="dream-single-post-main" itemscope itemtype="http://schema.org/Article">
      
  <meta itemprop="name" content="Flutter 游戏开发(flame) 04 分数, 存档和音效(4/5)">
  <meta itemprop="description" content="引言 分数和高分记录是任何游戏中不可或缺的一部分. 有些游戏根据收集的金币数量计算得分, 有些基于杀敌数, 有些则基于存活时间.
同样不能忽视音效和BGM(背景音乐). 加上它们, 游戏将会蜕变🦋.
如果一个游戏无声, 它就是不完整的.
欢迎来到Flutter&#43;Flame系列的第四章. 如果你还没有读过之前的章节, 建议你先阅读一下哦!🤭
🔴 注意: 本教程的背景音乐有些过时. 你可以先学本章教程, 之后再替换为这篇教程 下面是我们本系列教程的文章目录:
Flutter 游戏开发(flame) Flame介绍 Flutter 游戏开发(flame) 01 开发2D休闲游戏：消灭小飞蝇(1/5) Flutter 游戏开发(flame) 02 图形和动画(2/5) Flutter 游戏开发(flame) 03 界面和弹窗(3/5) Flutter 游戏开发(flame) 04 分数, 存档和音效(4/5) 本章 Flutter 游戏开发(flame) 05 收尾和打包(5/5) 需具备的条件 本系列教程之前的全部要求👈 更多的资源包 – 本教程提供了资源包, 但你也可以使用自己的. 推荐资源网站Open Game Art . 音效和音乐资源 - 这些也可以在游戏资源网站上找到, 比如Open Game Art . 还有专门的音频资源比如BenSound.com . 同样, 你必须查看许可并在游戏中表示感谢. 我们将使用与前一部分相同的编码规范👩‍🏫
👉在Github 或码云 上查看本章全部代码
新的资源包 这一部分中, 我们需要另一个资源包, 包含额外的图形、背景音乐和一些音效.">
  <meta itemprop="datePublished" content="2020-04-17T00:00:00+00:00">
  <meta itemprop="dateModified" content="2020-04-17T00:00:00+00:00">
  <meta itemprop="wordCount" content="2213">
  <meta itemprop="keywords" content="Flame,Flutter,游戏开发">

      <header>
        <h1 itemprop="headline">Flutter 游戏开发(flame) 04 分数, 存档和音效(4/5)</h1>
        <p class="text-sm">
          
            Friday, Apr 17, 2020
          

          | <span>11 minute read</span>

          
          | <span>Updated at
            
              Friday, Apr 17, 2020
            </span>
          
        </p>

        
        <div class="flex justify-between">
          

          <div class="flex items-center gap-2">
  
  

  
  
  
  
  
    <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary"
      href="https://x.com/intent/post?text=Flutter%20%e6%b8%b8%e6%88%8f%e5%bc%80%e5%8f%91%28flame%29%2004%20%e5%88%86%e6%95%b0,%20%e5%ad%98%e6%a1%a3%e5%92%8c%e9%9f%b3%e6%95%88%284/5%29&amp;url=http://localhost:1313/posts/post/2020/flutter-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91flame-04/" target="_blank" rel="noopener noreferrer"
      title="Share on X">
      <ion-icon class="group-hover:text-primary-content" name="logo-x"></ion-icon>
    </a>
  
    <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary"
      href="https://facebook.com/sharer/sharer.php?u=http://localhost:1313/posts/post/2020/flutter-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91flame-04/" target="_blank" rel="noopener noreferrer"
      title="Share on Facebook">
      <ion-icon class="group-hover:text-primary-content" name="logo-facebook"></ion-icon>
    </a>
  
    <a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary"
      href="https://wa.me/?text=Flutter%20%e6%b8%b8%e6%88%8f%e5%bc%80%e5%8f%91%28flame%29%2004%20%e5%88%86%e6%95%b0,%20%e5%ad%98%e6%a1%a3%e5%92%8c%e9%9f%b3%e6%95%88%284/5%29%20http://localhost:1313/posts/post/2020/flutter-%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91flame-04/" target="_blank" rel="noopener noreferrer"
      title="Share on WhatsApp">
      <ion-icon class="group-hover:text-primary-content" name="logo-whatsapp"></ion-icon>
    </a>
  

  
  
</div>

        </div>
      </header>

      <section id="dream-single-post-content" itemprop="articleBody">
        

        <h2 id="引言">引言</h2>
<p><strong>分数</strong>和<strong>高分记录</strong>是任何游戏中不可或缺的一部分. 有些游戏根据收集的金币数量计算得分, 有些基于杀敌数, 有些则基于存活时间.</p>
<p>同样不能忽视<strong>音效</strong>和<strong>BGM</strong>(背景音乐). 加上它们, 游戏将会蜕变🦋.</p>
<p>如果一个游戏无声, 它就是不完整的.</p>
<p>欢迎来到Flutter+Flame系列的第四章. 如果你还没有读过之前的章节, 建议你先阅读一下哦!🤭</p>
<p>🔴 注意: 本教程的背景音乐有些过时. 你可以先学本章教程, 之后再替换为<a href="https://jap.alekhin.io/background-music-in-a-flame-game" target="_blank">这篇教程</a>
</p>
<p>下面是我们本系列教程的文章目录:</p>
<ul>
<li><a href="https://www.bugcatt.com/archives/279" target="_blank">Flutter 游戏开发(flame) Flame介绍</a>
</li>
<li><a href="https://www.bugcatt.com/archives/292" target="_blank">Flutter 游戏开发(flame) 01 开发2D休闲游戏：消灭小飞蝇(1/5)</a>
</li>
<li><a href="https://www.bugcatt.com/archives/560" target="_blank">Flutter 游戏开发(flame) 02 图形和动画(2/5)</a>
</li>
<li><a href="https://www.bugcatt.com/archives/562" target="_blank">Flutter 游戏开发(flame) 03 界面和弹窗(3/5)</a>
</li>
<li><strong>Flutter 游戏开发(flame) 04 分数, 存档和音效(4/5) 本章</strong></li>
<li><a href="https://www.bugcatt.com/archives/731" target="_blank">Flutter 游戏开发(flame) 05 收尾和打包(5/5)</a>
</li>
</ul>
<h2 id="需具备的条件">需具备的条件</h2>
<ol>
<li>本系列教程之前的<strong>全部要求</strong>👈</li>
<li><strong>更多的资源包</strong> – 本教程提供了资源包, 但你也可以使用自己的. 推荐资源网站<a href="https://opengameart.org/" target="_blank">Open Game Art</a>
.</li>
<li><strong>音效和音乐资源</strong> - 这些也可以在游戏资源网站上找到, 比如<a href="https://opengameart.org/" target="_blank">Open Game Art</a>
. 还有专门的音频资源比如<a href="https://www.bensound.com/" target="_blank">BenSound.com</a>
. 同样, 你必须查看许可并在游戏中表示感谢.</li>
</ol>
<p>我们将使用与前一部分相同的<strong>编码规范</strong>👩‍🏫</p>
<p><strong>👉在<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/e72da435c3100a1601e16e75efc62fbaea6b3fe6" target="_blank">Github</a>
或<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/e72da435c3100a1601e16e75efc62fbaea6b3fe6" target="_blank">码云</a>
上查看本章全部代码</strong></p>
<h2 id="新的资源包">新的资源包</h2>
<p>这一部分中, 我们需要另一个资源包, 包含额外的图形、背景音乐和一些音效.</p>
<p><a href="https://jap.alekhin.io/wp-content/uploads/2019/04/resource-pack-part-4.zip" target="_blank"><img src="images/01.jpg" alt="下载"></a>
</p>
<p><a href="https://jap.alekhin.io/wp-content/uploads/2019/04/resource-pack-part-4.zip" target="_blank">点击图片或此处进行下载</a>
</p>
<hr>
<p>[epcl_box type=&ldquo;error&rdquo;]<strong>注意</strong>: 如果你遵循本教程, 则可以使用上述资源包. 本资源包是<a href="https://github.com/japalekhin/langaw" target="_blank">Github上Langaw(原作者)</a>
项目的一部分, 该项目获得<code>CC-BY-NC-ND</code>许可证的许可.[/epcl_box]</p>
<p>这意味着您可以共享、复制或者重新分发资源.</p>
<ul>
<li>你必须在感谢中提到, 提供许可证的链接, 并标明你是否进行了更改.</li>
<li>你不得将资源用于商业目的.</li>
<li>如果混合, 转换或者构建资源, 则不能分发修改后的资源.</li>
<li>你不得应用法律条款或技术措施, 在法律上限制他人做许可证允许的任何事情.</li>
</ul>
<p><a href="https://creativecommons.org/licenses/by-nc-nd/2.0/legalcode" target="_blank">点击此处了解有关 CC-BY-NC-ND 许可证的更多信息</a>
</p>
<p>[epcl_box type=&ldquo;notice&rdquo;]阿航在这里提醒: 目前国内的版权保护做的不够好. 希望大家能够保护资源原作者辛苦的创作🙏🙏! 不能使用未经许可且无版权的资源, 向盗版说不👋![/epcl_box]</p>
<hr>
<h2 id="继续开发">继续开发</h2>
<p>在这部分中, 我们将专注于<strong>分数</strong>和<strong>音效</strong>.</p>
<p>我们将使用另一个Flutter库来记录, 保存玩家的最高分.</p>
<p>至于音效, 我们将使用Flame中的音频库.</p>
<h3 id="第一步-评分">第一步: 评分</h3>
<p>目前为止, 游戏的目标只是不停的击杀小飞蝇, 直到玩家打偏. 除此之外, 没有目标.</p>
<p>我们来添加一个目标. 在玩家击中小飞蝇时得一分, 并累计到当前分数中. 与其他的游戏一样, 分数将从零开始, 并在新游戏时重置.</p>
<h4 id="新建用于记录分数的实例变量">新建用于记录分数的实例变量</h4>
<p>首先来到<code>./lib/langaw-game.dart</code>, 添加实例变量:</p>
<pre tabindex="0"><code>int score;
</code></pre><p><strong>小提示</strong>: 只需要添加到其他实例变量的下方.</p>
<p>在<code>initialize()</code>中, 初始化<code>score</code>的值:</p>
<pre tabindex="0"><code>score = 0;
</code></pre><p>我们需要玩家每次点击开始游戏按钮时, 重置此值.</p>
<p>跳转至<code>./lib/components/start-button.dart</code>, 在<code>onTapDown</code>处理器中添加:</p>
<pre tabindex="0"><code>game.score = 0;
</code></pre><h4 id="显示分数">显示分数</h4>
<p>到目前为止还是蛮顺利的😏! 接下来我们把分数显示出来.</p>
<p>我们可以选择在game类中进行渲染. 但是由于展示的东西比较少, 我们将该逻辑封装在自己的component.</p>
<p>创建一个组件<code>./lib/components/score-display.dart</code>:</p>
<pre tabindex="0"><code>import &#39;dart:ui&#39;;
import &#39;package:flutter/painting.dart&#39;;
import &#39;package:langaw/langaw-game.dart&#39;;

class ScoreDisplay {
  final LangawGame game;

  ScoreDisplay(this.game) {}

  void render(Canvas c) {}

  void update(double t) {}
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 从<code>import</code>开始, <code>dart:ui</code>使我们可以访问<code>Canvas</code>和<code>Offset</code>; <code>package:flutter/painting</code>使我们可以访问<code>TextPainter</code>; <code>package:langaw/langaw-game.dart</code>使我们可以访问game类.</p>
<p>🟡 提示: 我们已经有了一个名为<code>game</code>的实例变量, 在创建此类的实例时必须传入此变量. 与我们在签名的component中定义的其他component、controller和view一致.</p>
  </blockquote>

<p>让我们再添加三个实例变量: <code>TextPainter</code>类型的<code>painter</code>, 用于渲染分数值; <code>textStyle</code>控制分数样式; <code>position</code>决定分数的<code>Offset</code>(偏移量):</p>
<pre tabindex="0"><code>TextPainter painter;
TextStyle textStyle;
Offset position;
</code></pre><p>然后我们来处理构造函数, 在其中初始化实例变量值:</p>
<pre tabindex="0"><code>ScoreDisplay(this.game) {
  painter = TextPainter(
    textAlign: TextAlign.center,
    textDirection: TextDirection.ltr,
  );

  textStyle = TextStyle(
    color: Color(0xffffffff),
    fontSize: 90,
    shadows: [
      Shadow(
        blurRadius: 7,
        color: Color(0xff000000),
        offset: Offset(3, 3),
      ),
    ],
  );

  position = Offset.zero;
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 首先, 使用创建一个新的<code>TextPainter</code>用于初始化<code>painter</code>. 将其<code>textAlign</code>属性设置为居中, 因为我们将在屏幕上水平居中显示得分. 由于游戏是英文的(书写方向为从左至右), 我们将<code>textDirection</code>属性设置为<strong>LTR</strong>(Left-to-Right).</p>
<p>接下来, 使用<code>TextStyle</code>初始化<code>textStyle</code>属性. 设置三个属性:<code>color</code>设置为<code>Color(0xffffffff)</code>(纯白色); 字体大小为<code>90 逻辑像素</code>; 并且将<code>shadows</code>属性设置为包含一项的类型为<code>Shadow</code>的<code>List</code>. 此项定义一个阴影, 该阴影在右侧和底部偏移3个逻辑像素. 如果分数在另一个白色对象的顶部渲染(比如白云), 通过阴影可以增加对比度, 更容易看清.</p>
<p>想了解有关逻辑像素的更多信息, 请查看<a href="https://api.flutter.dev/flutter/dart-ui/Window/devicePixelRatio.html" target="_blank">Flutter官方文档(英文)</a>
</p>
  </blockquote>

<p><code>update</code>函数实际上发生在渲染之前(无论是初始化还是在game loop中), 所以让我们首先来写它:</p>
<pre tabindex="0"><code>void update(double t) {
  if ((painter.text?.text ?? &#39;&#39;) != game.score.toString()) {
    painter.text = TextSpan(
      text: game.score.toString(),
      style: textStyle,
    );

    painter.layout();

    position = Offset(
      (game.screenSize.width / 2) - (painter.width / 2),
      (game.screenSize.height * .25) - (painter.height / 2),
    );
  }
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 为了避免不必要的文本布局重新计算, 若变量<code>painter</code>的(文本属性的)<code>text</code>属性与当前分数的字符串相等, 就不会发生任何事情.</p>
  </blockquote>

<p>通过以下判断完成:</p>
<pre tabindex="0"><code>(painter.text?.text ?? &#39;&#39;) != game.score.toString()
</code></pre><p>这个表达式左侧看起来比较复杂, 所以在此解释一下. 此表达式使用Dart的null运算符.<br>
<code>?.</code>用于检查其左边的变量是否为<code>null</code>, 若为<code>null</code>则立即停止表达式并返回<code>null</code>. 我们已经知道<code>Painter</code>已经初始化且不为<code>null</code>, 因此我们不用检查它. 我们不确定的是<code>painter</code>的<code>text</code>属性是否为<code>null</code>, 因此我们使用该运算符.</p>
<p>使用的另一个运算符是<code>??.</code>. 若左侧不为null, 返回左侧表达式; 若为null, 返回右侧表达式.</p>
<p>对于整个表达式, 如果未设置<code>painter</code>的<code>text</code>属性, 则整个<code>painter.text?.text</code>返回<code>null</code>. 由于其后跟随了一个<code>??</code>, 因此if的返回值是一个空字符串. 最终的值是与<code>game.score.toString()</code>进行比较的结果. 另一方面, 如果没有设置<code>painter</code>的<code>text</code>属性, 则会返回当前的实际分数.</p>
<p>你可以在这篇<a href="https://www.bugcatt.com/archives/1025" target="_blank">《Dart 中的 Null-aware (null感知运算符)》</a>
获取Null-aware运算符(Null感知运算符)的更多信息!</p>
<p>现在如果<code>painter</code>的text与当前分数不一致, 我们用一个新的<code>TextSpan</code>的实例来更新它的text属性, 该实例将获取游戏中<code>score</code>变量和可重复使用的<code>textStyle</code>变量的当前值. 然后调用<code>layout</code>函数, 以便<code>TextPainter</code>可以计算刚刚分配的新文本的尺寸.</p>
<p>然后, 我们用一个新的<code>Offset</code>实例并将其分配给<code>position</code>变量. 我们希望分数水平居中. 至于垂直方位, 我们将score的垂直中心放在距屏幕顶部约1/4的高度上.</p>
<p>若有其他问题, 欢迎加入<a href="https://jq.qq.com/?_wv=1027&amp;k=5ETLFm3" target="_blank">我的Flame交流群(QQ)</a>
.</p>
<p>最终在<code>render</code>函数中, 添加下面的代码块:</p>
<pre tabindex="0"><code>void render(Canvas c) {
  painter.paint(c, position);
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 通过调用<code>painter</code>的<code>paint()</code>并提供所需的参数来渲染分数: 一个可以用于绘制的画布并且用<code>Offset</code>告诉painter在哪里绘制分数.</p>
  </blockquote>

<p>整个的<code>./lib/components/score-display.dart</code>文件应该像这样:</p>
<pre tabindex="0"><code>import &#39;dart:ui&#39;;
import &#39;package:flutter/painting.dart&#39;;
import &#39;package:langaw/langaw-game.dart&#39;;

class ScoreDisplay {
  final LangawGame game;
  TextPainter painter;
  TextStyle textStyle;
  Offset position;

  ScoreDisplay(this.game) {
    painter = TextPainter(
      textAlign: TextAlign.center,
      textDirection: TextDirection.ltr,
    );

    textStyle = TextStyle(
      color: Color(0xffffffff),
      fontSize: 90,
      shadows: [
        Shadow(
          blurRadius: 7,
          color: Color(0xff000000),
          offset: Offset(3, 3),
        ),
      ],
    );

    position = Offset.zero;
  }

  void render(Canvas c) {
    painter.paint(c, position);
  }

  void update(double t) {
    if ((painter.text?.text ?? &#39;&#39;) != game.score.toString()) {
      painter.text = TextSpan(
        text: game.score.toString(),
        style: textStyle,
      );

      painter.layout();

      position = Offset(
        (game.screenSize.width / 2) - (painter.width / 2),
        (game.screenSize.height * .25) - (painter.height / 2),
      );
    }
  }
}
</code></pre><h4 id="绘制分数component">绘制分数component</h4>
<p>若要真正的把分数component渲染在屏幕上, 我们必须将其添加至game类, 并将其包含在game loop中.</p>
<p>老规矩, 打开<code>./lib/langaw-game.dart</code>, 导入刚刚创建的类:</p>
<pre tabindex="0"><code>import &#39;package:langaw/components/score-display.dart&#39;;
</code></pre><p>创建<code>ScoreDisplay</code>类型的实例变量:</p>
<pre tabindex="0"><code>ScoreDisplay scoreDisplay;
</code></pre><p>在<code>initialize()</code>中(调用<code>resize</code>之后)创建一个新的<code>ScoreDisplay</code>实例, 并将其赋值给<code>scoreDisplay</code>变量(注意大小写哦), 最好在初始化按钮的下方:</p>
<pre tabindex="0"><code>scoreDisplay = ScoreDisplay(this);
</code></pre><p>在<code>update()</code>内部, 判断当前的界面是否为<code>View.playing</code>, 若是, 则调用<code>scoreDisplay</code>的<code>update</code>函数. 你可以将此行放在任何地方.</p>
<p>在函数末尾添加:</p>
<pre tabindex="0"><code>if (activeView == View.playing) scoreDisplay.update(t);
</code></pre><p>然后在game类的<code>render()</code>中, 我们做类似的事情, 但是是调用<code>render()</code>. 记住在此函数内写入行的顺序是图形在屏幕上绘制的实际顺序.</p>
<p>我们希望score正好高于背景, 低于其他的所有东西. 小飞蝇可以飞越它. 因此, 在渲染背景后添加:</p>
<pre tabindex="0"><code>if (activeView == View.playing) scoreDisplay.render(canvas);
</code></pre><p><img src="images/02-3.png" alt=""></p>
<h4 id="处理小飞蝇加分">处理小飞蝇加分</h4>
<p>玩家想要加分, 必须击落小飞蝇.</p>
<p>要拥有这套逻辑, 打开<code>./lib/components/fly.dart</code>. 为了等下使用, 导入<code>View</code>枚举类.</p>
<pre tabindex="0"><code>import &#39;package:langaw/view.dart&#39;;
</code></pre><p>在<code>onTapDown</code>处理器内部, 替换已存在的那一行代码为:</p>
<pre tabindex="0"><code>if (!isDead) {
  isDead = true;

  if (game.activeView == View.playing) {
    game.score += 1;
  }
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 当一只小飞蝇被点击, 我们首先要检查它是否活着(<code>!isDead</code>). 如果小飞蝇已经挂掉, 那么什么也不会发生. 如果还活着, 我们设置其<code>isDead</code>参数值为<code>true</code>让component知道小飞蝇已经死掉.</p>
<p>之后, 我们将判断当前界面是否为playing. 如果玩家没有开始游戏, 那么就不需要新增分数. 若玩家在游戏中, 则增加分数. 这将更新<code>ScoreDisplay</code>实例.</p>
  </blockquote>

<p>运行游戏, 你应该可以看到分数了:</p>
<p><img src="images/03-2.png" alt=""></p>
<h4 id="进阶版小飞蝇">进阶版小飞蝇</h4>
<p>小飞蝇不仅仅是飞来飞去, 它们同时也会进食. 另外, 若玩家只是伺机而动精准击落小飞蝇, 多少有些无聊🤐🤐.</p>
<p>让我们再来添加一个游戏失败的条件😲.</p>
<p>一旦小飞蝇出现在屏幕上, 它会显示一个倒数的计数器. 这个计数器相当于小飞蝇还有多久&quot;吃完&quot;. 当计数器归零时, 意味着小飞蝇&quot;吃完&quot;, 游戏失败.</p>
<p>这样游戏就增加了挑战性, 没有之前那么无聊了.</p>
<p>我们必须确保玩家可以注意到计数器, 看看那些小飞蝇即将归零. 我们将使用资源包中的标注图形来显示此计数器.</p>
<p>让我们添加资源包中的标注图形<code>./assets/images/ui/callout.png</code>到资源目录中, 然后要把它注册进<code>./pubspec.yaml</code>中:</p>
<pre tabindex="0"><code>    - assets/images/ui/callout.png
</code></pre><p>然后打开<code>./lib/main.dart</code>并添加<code>ui/callout.png</code>到预加载的图像List中. 在<code>Flame.images.loadAll</code>中:</p>
<pre tabindex="0"><code>Flame.images.loadAll([
  // 其他的图片资源
  &#39;ui/callout.png&#39;,
]);
</code></pre><p>然后, 创建为此标注创建一个component, <code>./lib/components/callout.dart</code>:</p>
<pre tabindex="0"><code>import &#39;dart:ui&#39;;
import &#39;package:flame/sprite.dart&#39;;
import &#39;package:flutter/material.dart&#39;;
import &#39;package:langaw/components/fly.dart&#39;;

class Callout {
  final Fly fly;
  Rect rect;
  Sprite sprite;
  double value;

  TextPainter tp;
  TextStyle textStyle;
  Offset textOffset;

  Callout(this.fly) {}

  void render(Canvas c) {}

  void update(double t) {}
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 这里我们又创建了一个相当标准的component. 只不过引入的不是<code>game</code>而是fly. 就像fly component的子类一样.</p>
  </blockquote>

<p>此类具有其他实例变量, 这些实例变量将用于绘制标注中的值.</p>
<p>继续初始化构造函数的值:</p>
<pre tabindex="0"><code>Callout(this.fly) {
  sprite = Sprite(&#39;ui/callout.png&#39;);
  value = 1;
  tp = TextPainter(
    textAlign: TextAlign.center,
    textDirection: TextDirection.ltr,
  );
  textStyle = TextStyle(
    color: Color(0xff000000),
    fontSize: 15,
  );
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 别头大, body实际上只有4行. 为了便于阅读才把它垂直伸展开. 在构造函数内部, 我们只为实例变量分配初始化值. 在<code>update</code>函数中, 我们将变量减少一定的值, 若降至0, 则将游戏中的当前界面改为<code>you lose</code>. 当然, 上述操作仅在界面为<code>playing</code>时才进行.</p>
  </blockquote>

<p>先导入:</p>
<pre tabindex="0"><code>import &#39;package:langaw/view.dart&#39;;
</code></pre><p>再将以下代码块放入<code>update</code>函数中:</p>
<pre tabindex="0"><code>if (fly.game.activeView == View.playing) {
  value = value - .5 * t;
  if (value &lt;= 0) {
    fly.game.activeView = View.lost;
  }
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 首先, 检查界面是否为<code>View.playing</code>, 若是则从值中减去<code>0.5 * t</code>. <code>t</code>变量包含上次调用<code>update</code>时间的1/2. 此计算可确保小飞蝇的寿命为2秒.</p>
<p>然后我们判断该值是否为0. 若是则告诉玩家输掉游戏.</p>
  </blockquote>

<p>之后我们确保此标注的<code>rect</code>变量已更新, 以便<code>render()</code>相对于父级<code>fly</code>正确放置. 该代码块刚好在减少<code>value</code>块下方:</p>
<pre tabindex="0"><code>rect = Rect.fromLTWH(
  fly.flyRect.left - (fly.game.tileSize * .25),
  fly.flyRect.top - (fly.game.tileSize * .5),
  fly.game.tileSize * .75,
  fly.game.tileSize * .75,
);
</code></pre>


  <blockquote>
    <p>💡 代码解析: 到目前为止, 与我们完成的所有其他<code>Rect</code>的初始化一致, 实际上只有一行代码. 最后两个参数是<code>rect</code>的<strong>宽</strong>度和<strong>高</strong>度, 它们都设置为区块大小的3/4. <strong>L</strong>eft的值与小飞蝇的<code>rect</code>减去区块大小的1/4相同. <strong>T</strong>op的值使用相同的逻辑, 不同的是减去区块大小的1/2.</p>
  </blockquote>

<p>仍然在<code>update</code>函数中, 最后的代码块将更新文本painter, 该painter在标注图形中绘制当前的值.</p>
<pre tabindex="0"><code>tp.text = TextSpan(
  text: (value * 10).toInt().toString(),
  style: textStyle,
);
tp.layout();
textOffset = Offset(
  rect.center.dx - (tp.width / 2),
  rect.top + (rect.height * .4) - (tp.height / 2),
);
</code></pre>


  <blockquote>
    <p>💡 代码解析: 由于我们已经使用<code>TextPainter</code>类的实例初始化了<code>tp</code>变量, 因此我们只是将其<code>text</code>属性设置为<code>TextSpan</code>类的实例, 将当前值乘以10转换为整数, 然后转换为字符串.</p>
  </blockquote>

<p>该值乘以10, 就好像从9数到0一行.</p>
<p>然后我们调用<code>layout</code>函数, 以便<code>tp</code>知道将给文本字符串和提供给它的样式以及文本大小.</p>
<p>接下来, 我们使用新的<code>Offset</code>来更新<code>textOffset</code>的值, 该<code>Offset</code>会传递一个计算, 将文本居中在标注的白色区域内.</p>
<p>最后编写<code>render()</code>:</p>
<pre tabindex="0"><code>void render(Canvas c) {
    if (rect != null){
      sprite.renderRect(c, rect);
      tp.paint(c, textOffset);
    }
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 首先我们渲染标注(现在应该比较熟悉了). 然后我们使用<code>TextPainter</code>的<code>paint</code>函数来绘制文本, 并传递我们刚刚在<code>update</code>函数中更新的<code>textOffset</code>变量.</p>
  </blockquote>

<p>整个的Callout类:</p>
<pre tabindex="0"><code>import &#39;dart:ui&#39;;
import &#39;package:flame/sprite.dart&#39;;
import &#39;package:flutter/material.dart&#39;;
import &#39;package:langaw/components/fly.dart&#39;;

import &#39;package:langaw/view.dart&#39;;

class Callout {
  final Fly fly;
  Rect rect;
  Sprite sprite;
  double value;

  TextPainter tp;
  TextStyle textStyle;
  Offset textOffset;

  Callout(this.fly) {
    sprite = Sprite(&#39;ui/callout.png&#39;);
    value = 1;
    tp = TextPainter(
      textAlign: TextAlign.center,
      textDirection: TextDirection.ltr,
    );
    textStyle = TextStyle(
      color: Color(0xff000000),
      fontSize: 15,
    );
  }

  void render(Canvas c) {
    if (rect != null){
      sprite.renderRect(c, rect);
      tp.paint(c, textOffset);
    }
  }

  void update(double t) {
    if (fly.game.activeView == View.playing) {
      value = value - .5 * t;
      if (value &lt;= 0) {
        fly.game.activeView = View.lost;
      }
    }
    rect = Rect.fromLTWH(
      fly.flyRect.left - (fly.game.tileSize * .25),
      fly.flyRect.top - (fly.game.tileSize * .5),
      fly.game.tileSize * .75,
      fly.game.tileSize * .75,
    );

    tp.text = TextSpan(
      text: (value * 10).toInt().toString(),
      style: textStyle,
    );
    tp.layout();
    textOffset = Offset(
      rect.center.dx - (tp.width / 2),
      rect.top + (rect.height * .4) - (tp.height / 2),
    );
  }
}
</code></pre><p>现在我们只需将标注component添加至</p>
<p><code>Fly</code>类中. 此过程应该也比较熟悉了, 因为我们在前面做过类似的操作. 打开<code>./lib/components/fly.dart</code>, 导入<code>Callout</code>:</p>
<pre tabindex="0"><code>import &#39;package:langaw/components/callout.dart&#39;;
</code></pre><p>添加实例变量用于保存callout:</p>
<pre tabindex="0"><code>Callout callout;
</code></pre><p>在<code>Fly</code>构造函数中, 初始化<code>callout</code>变量并且使用<code>this</code>关键字用于传入当前的Fly:</p>
<pre tabindex="0"><code>callout = Callout(this);
</code></pre><p>如果小飞蝇没有死掉, 那么标注就需要进行更新. 因此在<code>Fly</code>的<code>update</code>函数内, 在<code>else</code>(小飞蝇尚未死掉)代码块底部添加:</p>
<pre tabindex="0"><code>callout.update(t);
</code></pre><p>最终, 若小飞蝇还没死(<code>else</code>块内)并且当前的界面为<code>playing</code>, 则渲染标注. 添加到<code>render</code>中:</p>
<pre tabindex="0"><code>if (game.activeView == View.playing) {
  callout.render(c);
}
</code></pre><p>🟢 运行游戏, 看看效果:</p>
<p><img src="images/04-1.gif" alt=""></p>
<p><strong>👉在<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/904d05b9be2293cd9dede4acfcc86c93e1097468" target="_blank">Github</a>
或<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/904d05b9be2293cd9dede4acfcc86c93e1097468" target="_blank">码云</a>
上查看这部分的代码.</strong></p>
<h3 id="第二步-存储最高分">第二步: 存储最高分</h3>
<p>如果游戏没有记录最高分, 那么获得这个宝贵的分数将是一种浪费.</p>
<p>让我们来记录最高分, 这样玩家就可以不断突破自己, 取得更高的分数.</p>
<p>记录最高分, 仅需存储一条数据. 只是一个整数.</p>
<p>这个简单的任务可以通过<code>shared_preferences</code>第三方库来解决. 这个库包含<code>SharedPreferences</code>, 它可以处理简单的数据(数字、字符串以及布尔值). 它还在内部处理根据不同操作系统(IOS和Android)来保存数据.</p>



  <blockquote>
    <p>若想了解<code>SharedPreference</code>更多内容, 欢迎阅读阿航的这篇<a href="https://www.bugcatt.com/archives/165" target="_blank">《Flutter 数据存储 SharedPreferences》</a>
. 里面包含超详细讲解.</p>
  </blockquote>

<h4 id="准备数据存储">准备数据存储</h4>
<p>就像Flame一样, <code>shared_preferences</code>也是Flutter的一个插件. 若要安装此插件, 打开<code>./pubspec.yaml</code>并且添加以下行在<code>dependencies</code>中, <code>flame</code>下方:</p>
<pre tabindex="0"><code>    shared_preferences: ^0.5.1+2
</code></pre>


  <blockquote>
    <p>🟡 提示: 注意缩进! 若格式有误将会出现错误哦!</p>
  </blockquote>

<p>运行<code>packages get</code>.</p>
<p>为了更轻松的读写数据, 我们需要在<code>game</code>的context中创建<code>SharedPreference</code>实例变量.</p>
<p>打开<code>./lib/langaw-game.dart</code>, 导入<code>shared_preferences</code>:</p>
<pre tabindex="0"><code>import &#39;package:shared_preferences/shared_preferences.dart&#39;;
</code></pre><p>然后在<code>LangawGame</code>类中添加<code>final</code>实例变量. 这样甚至会在创建<code>LangawGame</code>实例前就准备好<code>SharedPreference</code>实例:</p>
<pre tabindex="0"><code>final SharedPreferences storage;
</code></pre><p>标记为<code>final</code>的任何实例变量必须在声明时具有初始值, 否则必须通过构造函数将其传递给它. 因此我们来修改构造函数:</p>
<pre tabindex="0"><code>LangawGame(this.storage) {
  initialize();
}
</code></pre><p>在构造函数中, 使用以<code>this.</code>为前缀的参数时, 意味着传递给它的任何值都是其名称所代表的变量值.</p>
<p>在其之后, 跳转至<code>./lib/main.dart</code>文件, 以便我们可以正确初始化game类.</p>
<p>首先导入<code>shared_preferences</code>:</p>
<pre tabindex="0"><code>import &#39;package:shared_preferences/shared_preferences.dart&#39;;
</code></pre><p>接下来在<code>main</code>函数中创建<code>SharedPreferences</code>的实例:</p>
<pre tabindex="0"><code>SharedPreferences storage = await SharedPreferences.getInstance();
</code></pre>


  <blockquote>
    <p>🟡 提示: <code>.getInstance</code>工厂返回一个<code>Future</code>, 因此我们必须使用<code>await</code>关键字来等待<code>Futrue</code>返回内容(需要<code>SharedPreferences</code>的一个实例). <code>main</code>函数已经为<code>async</code>, 因此我们可以等待<code>main</code>中的<code>Future</code>.</p>
  </blockquote>

<p>在声明<code>LangawGame</code>实例的代码部分, 传递我们刚刚声明的第一个(也是唯一一个)参数的<code>storage</code>变量:</p>
<pre tabindex="0"><code>LangawGame game = LangawGame(storage);
</code></pre><p>现在只要我们可以访问game, 就可以访问<code>storage</code>变量(LangawGame类的实例).</p>
<h4 id="显示最高分">显示最高分</h4>
<p>我们的游戏应该始终显示最高分. 我们可以使用类似<code>ScoreDisplay</code>的另一个component来执行此操作.</p>
<p>创建<code>./lib/components/highscore-display.dart</code>文件, 并编写内容:</p>
<pre tabindex="0"><code>import &#39;dart:ui&#39;;
import &#39;package:flutter/painting.dart&#39;;
import &#39;package:langaw/langaw-game.dart&#39;;

class HighscoreDisplay {
  final LangawGame game;
  TextPainter painter;
  TextStyle textStyle;
  Offset position;

  HighscoreDisplay(this.game) {}

  void render(Canvas c) {}
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 如你所见, 这是一个相当标准的不含<code>update</code>的类文件. 因为分数将会被手动更新.</p>
  </blockquote>

<p>实例变量必须在创建此类实例时被初始化, 因此修改构造函数为:</p>
<pre tabindex="0"><code>HighscoreDisplay(this.game) {
  painter = TextPainter(
    textAlign: TextAlign.center,
    textDirection: TextDirection.ltr,
  );

  Shadow shadow = Shadow(
    blurRadius: 3,
    color: Color(0xff000000),
    offset: Offset.zero,
  );

  textStyle = TextStyle(
    color: Color(0xffffffff),
    fontSize: 30,
    shadows: [shadow, shadow, shadow, shadow],
  );

  position = Offset.zero;

  updateHighscore();
}
</code></pre>


  <blockquote>
    <p>💡 构造函数解析: 第一部分使用<code>TextPainter</code>的类实例初始化<code>painter</code>变量, 该类包含文本对齐和方向所需的值.</p>
<p>接下来我们将创建一个内部的<code>Shadow</code>变量, 将其添加到下面初始化的<code>textStyle</code>时, 将有助于创建阴影效果. 我们放置了<code>shadow</code>变量的四个实例, 因此当它们重叠时, 它们包含阴影.</p>
<p><code>position</code>变量设置初始化为零<code>(0, 0)</code>.</p>
<p>最后, 我们调用一个名为<code>updateHighscore()</code>的函数. 这将自动更新高分值以及对painter对象绘制的文本进行处理.</p>
  </blockquote>

<p>接下来添加函数, 用于构建手动更新:</p>
<pre tabindex="0"><code>void updateHighscore() {
  int highscore = game.storage.getInt(&#39;highscore&#39;) ?? 0;

  painter.text = TextSpan(
    text: &#39;High-score: &#39; + highscore.toString(),
    style: textStyle,
  );

  painter.layout();

  position = Offset(
    game.screenSize.width - (game.tileSize * .25) - painter.width,
    game.tileSize * .25,
  );
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 在这个函数中, 我们从保存在game类的<code>storage</code>变量中的<code>SharedPreference</code>实例中获得最高分的值. 由于我们的分数(和最高分)只是整数, 所以我们将其存储为<code>integer</code>.</p>
<p>然后我们更新<code>painter</code>的<code>text</code>属性为一个新的<code>TextSpan</code>, 并传入刚刚的最高分. 这和<code>ScoreDisplay</code>中的更新过程相似.</p>
<p>调用<code>layout</code>(决定绘制文本大小)后, 我们将<code>position</code>变量设置为新的<code>Offset</code>, 其值将使绘制文本的右侧位于屏幕右侧边缘约1/4处, 而其顶部位于屏幕的右边缘. 与屏幕顶部边缘的距离相同.</p>
  </blockquote>

<p>我们通过编写<code>render</code>函数的内容来完成该类:</p>
<pre tabindex="0"><code>void render(Canvas c) {
  painter.paint(c, position);
}
</code></pre><p>没有复杂的点, 只需在<code>updateHighScore</code>函数中预先计算的位置将最高分绘制到屏幕上即可.</p>
<p>整个<code>HighscoreDisplay</code>类文件:</p>
<pre tabindex="0"><code>import &#39;dart:ui&#39;;
import &#39;package:flutter/painting.dart&#39;;
import &#39;package:langaw/langaw-game.dart&#39;;

class HighscoreDisplay {
  final LangawGame game;
  TextPainter painter;
  TextStyle textStyle;
  Offset position;

  HighscoreDisplay(this.game) {
    painter = TextPainter(
      textAlign: TextAlign.center,
      textDirection: TextDirection.ltr,
    );

    Shadow shadow = Shadow(
      blurRadius: 3,
      color: Color(0xff000000),
      offset: Offset.zero,
    );

    textStyle = TextStyle(
      color: Color(0xffffffff),
      fontSize: 30,
      shadows: [shadow, shadow, shadow, shadow],
    );

    position = Offset.zero;

    updateHighscore();
  }

  void updateHighscore() {
    int highscore = game.storage.getInt(&#39;highscore&#39;) ?? 0;

    painter.text = TextSpan(
      text: &#39;High-score: &#39; + highscore.toString(),
      style: textStyle,
    );

    painter.layout();

    position = Offset(
      game.screenSize.width - (game.tileSize * .25) - painter.width,
      game.tileSize * .25,
    );
  }

  void render(Canvas c) {
    painter.paint(c, position);
  }
}
</code></pre><p>现在就剩把它添加至game类中了, 打开<code>./lib/langaw-game.dart</code>, 导入<code>HighscoreDisplay</code>:</p>
<pre tabindex="0"><code>import &#39;package:langaw/components/highscore-display.dart&#39;;
</code></pre><p>添加实例变量, 类型为<code>HighscoreDisplay</code>:</p>
<pre tabindex="0"><code>HighscoreDisplay highscoreDisplay;
</code></pre><p>在<code>initialize</code>函数内, 初始化<code>highscoreDisplay</code>(最好在<code>scoreDisplay</code>下面):</p>
<pre tabindex="0"><code>highscoreDisplay = HighscoreDisplay(this);
</code></pre><p>最后在<code>render</code>内, 渲染背景后(渲染<code>scoreDisplay</code>前), 使用以下代码渲染最高分:</p>
<pre tabindex="0"><code>highscoreDisplay.render(canvas);
</code></pre><p>尝试运行游戏, 应该可以在屏幕右上角看到分数显示(目前为0):</p>
<p><img src="images/05-2.png" alt=""></p>
<h4 id="更新最高分">更新最高分</h4>
<p>目前的最高分是暂时无效的. 只要满足以下条件, 就需要更新它:</p>
<ol>
<li>玩家当前界面是&quot;playing&quot;</li>
<li>当前分数高于最高分</li>
</ol>
<p>为此我们打开<code>./lib/components/fly.dart</code>. 在<code>onTapDown</code>处理器中, 我已经有了一个<code>if</code>块, 用于判断当前界面是否为&quot;playing&quot;.</p>
<p>在该块内, 我们添加<code>1</code>分下面, 插入以下代码:</p>
<pre tabindex="0"><code>if (game.score &gt; (game.storage.getInt(&#39;highscore&#39;) ?? 0)) {
  game.storage.setInt(&#39;highscore&#39;, game.score);
  game.highscoreDisplay.updateHighscore();
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 此块仅检查分数是否高于当前保存为最高分的分数. 因为经过<code>if</code>的判断, 我们已经知道玩家正在&quot;playing&quot;.</p>
<p>如果满足条件, 则首先调用<code>setInt</code>函数, 传递字符串<code>highscore</code>和新值. 此函数和<code>getInt</code>类似, 但是它传递的是引用, 而不是它的值.</p>
<p>之后, 我们手动更新<code>HighscoreDisplay</code>实例, 以向玩家显示他的分数是当前最高分.</p>
  </blockquote>

<p>代码截图:</p>
<p><img src="images/06-2.png" alt=""></p>
<p>🟢 现在运行游戏, 你应该会看到: 每次超过当前最高分, 都会更新最高分. 开启下一局游戏时, 该最高分会被保留. 这样会不断使玩家挑战自己, 打破记录.</p>
<p><img src="images/07-2.png" alt=""></p>
<p><strong>👉在<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/09ec49172b28ec5d7b3215816618bae6c4d4c133" target="_blank">Github</a>
或<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/09ec49172b28ec5d7b3215816618bae6c4d4c133" target="_blank">码云</a>
上查看这部分的代码.</strong></p>
<h3 id="第三步-音效">第三步: 音效</h3>
<p>🟡 提示: Mac和IOS设备在播放<code>.ogg</code>文件时可能出现问题. 如果您遇到类似的播放异常, 请用你喜欢的音频转换工具将<code>.ogg</code>文件转换为<code>.mp3</code>文件. 另外也请注意要把对应的<code>.ogg</code>后缀改为<code>.mp3</code>.</p>
<p>一个游戏没有音乐将会相当单调. 幸运的是, Flame可以很轻松的为游戏添加声音!🤪🤪</p>
<p>首先创建一个目录, 用于存放音效文件. 创建目录<code>./assets/audio/sfx</code>, 并把资源包中<code>./audio/sfx</code>目录下全部文件放在创建的目录中:</p>
<pre tabindex="0"><code>./assets
./assets/audio
./assets/audio/sfx
./assets/audio/sfx/haha1.ogg
./assets/audio/sfx/haha2.ogg
./assets/audio/sfx/haha3.ogg
./assets/audio/sfx/haha4.ogg
./assets/audio/sfx/haha5.ogg
./assets/audio/sfx/ouch1.ogg
./assets/audio/sfx/ouch2.ogg
./assets/audio/sfx/ouch3.ogg
./assets/audio/sfx/ouch4.ogg
./assets/audio/sfx/ouch5.ogg
./assets/audio/sfx/ouch6.ogg
./assets/audio/sfx/ouch7.ogg
./assets/audio/sfx/ouch8.ogg
./assets/audio/sfx/ouch9.ogg
./assets/audio/sfx/ouch10.ogg
./assets/audio/sfx/ouch11.ogg
</code></pre><p>下一步将它们注册进入Flutter中, 编译时将它们打包进去, 在<code>./pubspec.yaml</code>的<code>assets</code>中添加:</p>
<pre tabindex="0"><code> assets:
    - assets/audio/sfx/haha1.ogg
    - assets/audio/sfx/haha2.ogg
    - assets/audio/sfx/haha3.ogg
    - assets/audio/sfx/haha4.ogg
    - assets/audio/sfx/haha5.ogg
    - assets/audio/sfx/ouch1.ogg
    - assets/audio/sfx/ouch2.ogg
    - assets/audio/sfx/ouch3.ogg
    - assets/audio/sfx/ouch4.ogg
    - assets/audio/sfx/ouch5.ogg
    - assets/audio/sfx/ouch6.ogg
    - assets/audio/sfx/ouch7.ogg
    - assets/audio/sfx/ouch8.ogg
    - assets/audio/sfx/ouch9.ogg
    - assets/audio/sfx/ouch10.ogg
    - assets/audio/sfx/ouch11.ogg
</code></pre><p>同样的, 一定要注意缩进.</p>
<p>然后进入<code>./lib/main.dart</code>, 在<code>main</code>函数中添加以下代码行:</p>
<pre tabindex="0"><code>Flame.audio.disableLog();
Flame.audio.loadAll([
  &#39;sfx/haha1.ogg&#39;,
  &#39;sfx/haha2.ogg&#39;,
  &#39;sfx/haha3.ogg&#39;,
  &#39;sfx/haha4.ogg&#39;,
  &#39;sfx/haha5.ogg&#39;,
  &#39;sfx/ouch1.ogg&#39;,
  &#39;sfx/ouch2.ogg&#39;,
  &#39;sfx/ouch3.ogg&#39;,
  &#39;sfx/ouch4.ogg&#39;,
  &#39;sfx/ouch5.ogg&#39;,
  &#39;sfx/ouch6.ogg&#39;,
  &#39;sfx/ouch7.ogg&#39;,
  &#39;sfx/ouch8.ogg&#39;,
  &#39;sfx/ouch9.ogg&#39;,
  &#39;sfx/ouch10.ogg&#39;,
  &#39;sfx/ouch11.ogg&#39;,
]);
</code></pre>


  <blockquote>
    <p>💡 代码解析: 第一行禁用了debug日志, 以免在控制台中刷屏.</p>
<p>接下来的几行实际上只有一行, 一个函数调用的参数为数组. 为了便于阅读, 数组被垂直展开. 这将预加载所有音效文件, 以便将它们缓存并随时可被游戏播放.</p>
<p>你可能注意到了, 和预加载图片的格式是一致的.</p>
  </blockquote>

<p>下一步是在适当的位置播放声音.</p>
<p>我们基本上有两种声音效果. 一种是**&ldquo;ouch&rdquo;<strong>(类似于惨叫), 另一种是</strong>&ldquo;haha&rdquo;<strong>(哈哈笑). 当玩家击落小飞蝇时, 会播放</strong>&ldquo;ouch&rdquo;<strong>, 玩家打偏的时候会播放</strong>&ldquo;haha&rdquo;**.</p>
<p>💡 你可能想知道为什么有整整11个**&ldquo;haha&rdquo;<strong>和5个</strong>&ldquo;ouch&rdquo;**.</p>
<p>在这里分享一个游戏开发秘诀.</p>
<p>任何重复都是无聊的. 比如一个笑话讲了十次就不再是笑话了. 生活中大多数事情都是重复的(呼吸、 日子以及game loop), 但是我们可以通过在播放时使用多个版本的声音效果, 是游戏的声音添加一些趣味. 如果我们每次击杀小飞蝇时都播放相同的声音, 它可能会很快被玩家玩腻.</p>
<p>为此, 每次我们需要播放声音时, 就会从<code>game</code>的<code>rnd</code>中获取一个随机数, 并播放相应的&quot;相同&quot;的随机一种音效.</p>
<p>打开<code>./lib/components/fly.dart</code>, 导入Flame:</p>
<pre tabindex="0"><code>import &#39;package:flame/flame.dart&#39;;
</code></pre><p>然后在<code>onTapDown</code>处理器后, 在判断被点击的小飞蝇没有死的后面添加:</p>
<pre tabindex="0"><code>Flame.audio.play(&#39;sfx/ouch&#39; + (game.rnd.nextInt(11) + 1).toString() + &#39;.ogg&#39;);
</code></pre>


  <blockquote>
    <p>💡 代码解析: 若要调用Flame音频库的<code>play</code>函数, 只需要传入音频文件名.</p>
<p>详细介绍一下随机生成器: <code>(game.rnd.nextInt(11) + 1)</code>. 函数<code>nextInt()</code>接收一个整数作为参数, 并返回一个从0到所传参数(不包含)的随机值的整数. 因此若传递11, 则可以得到<code>0</code>到<code>10</code>之间的任意数字. 然后将其加1, 使返回的数字变为从<code>1</code>到<code>11</code>, 这样刚好匹配我们的文件名(<code>ouch1.ogg</code>, <code>ouch2.ogg</code>, …, <code>ouch11.ogg</code>).</p>
  </blockquote>

<p>🟢 运行游戏, 你会发现击落小飞蝇后, 小飞蝇会发出声音.</p>
<p>打开<code>./lib/langaw-game.dart</code>, 修改<code>if</code>块的代码, 该代码判断玩家是否&quot;正在玩游戏&quot;并且点击但未击中小飞蝇.<br>
找到:</p>
<pre tabindex="0"><code>if (activeView == View.playing &amp;&amp; !didHitAFly) {
  activeView = View.lost;
}
</code></pre><p>改为</p>
<pre tabindex="0"><code>if (activeView == View.playing &amp;&amp; !didHitAFly) {
  Flame.audio.play(&#39;sfx/haha&#39; + (rnd.nextInt(5) + 1).toString() + &#39;.ogg&#39;);
  activeView = View.lost;
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 我们同样调用了<code>play</code>函数, 但是播放的是5个<code>haha</code>的变体.</p>
  </blockquote>

<p>我们还有另一种失败条件, 所以打开<code>./lib/components/callout.dart</code>, 导入:</p>
<pre tabindex="0"><code>import &#39;package:flame/flame.dart&#39;;
</code></pre><p>在<code>update()</code>内部, 修改<code>if</code>块, 该块判断<code>value</code>是否小于等于0:</p>
<p>找到:</p>
<pre tabindex="0"><code>if (value &lt;= 0) {
  fly.game.activeView = View.lost;
}
</code></pre><p>改为:</p>
<pre tabindex="0"><code>if (value &lt;= 0) {
  Flame.audio.play(&#39;sfx/haha&#39; + (fly.game.rnd.nextInt(5) + 1).toString() + &#39;.ogg&#39;);
  fly.game.activeView = View.lost;
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 与上面的代码基本相同, 只是访问game的<code>rnd</code>对象的方式不同. 在此类中, 我们没有直接引用game实例. 我们先通过<code>fly</code>引用, 然后再通过<code>fly</code>的<code>game</code>进行引用, 然后再转到<code>rnd</code>对象.</p>
  </blockquote>

<p>🟢 尝试运行游戏, 看看效果!</p>
<p><strong>👉在<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/ad2d571fb9b5db4bb8e77434c4e0c101b101f0df" target="_blank">Github</a>
或<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/ad2d571fb9b5db4bb8e77434c4e0c101b101f0df" target="_blank">码云</a>
上查看这部分的代码.</strong></p>
<h3 id="第四步-背景音乐">第四步: 背景音乐</h3>
<p>是时候添加BGM(背景音乐)了!</p>
<p>背景音乐决定了游戏的气氛或者玩家当前的界面. 对于此游戏, 我们将会有两种不同的背景音乐, 一种用于play界面, 另一种用于其他.</p>
<p>首先, 将资源包的<code>./audio/bgm</code>内的文件复制到游戏目录中的<code>./lib/assets/audio/bgm</code>中, 结构如下:</p>
<pre tabindex="0"><code>./assets
./assets/audio
./assets/audio/bgm
./assets/audio/bgm/home.mp3
./assets/audio/bgm/playing.mp3
</code></pre><p>这些文件也同样要绑定至包中, 所以把它们加在<code>./pubspec.yaml</code>资源中:</p>
<pre tabindex="0"><code>  assets:
    - assets/audio/bgm/home.mp3
    - assets/audio/bgm/playing.mp3
    - assets/audio/sfx/haha1.ogg
</code></pre><p>BGM将会被循环播放, 因此我们使它们预加载. 打开<code>./lib/main.dart</code>, 并将BGM文件包含在传入<code>Flame.audio.loadAll</code>的数组中:</p>
<pre tabindex="0"><code>Flame.audio.loadAll([
  &#39;bgm/home.mp3&#39;,
  &#39;bgm/playing.mp3&#39;,
  &#39;sfx/haha1.ogg&#39;,
</code></pre><p>使用SFX(音效), 我们可以只播放他们就放手不管, 因为他们短且只有一次. 对于BGM, 我们需要可以对它们进行控制, 比如暂停、继续播放和搜索.</p>
<p>我们将存储这些引用, 保留在game类的变量, 因此我们打开<code>./lib/langaw-game.dart</code>.</p>
<p>首先, 我们需要访问<code>AudioPlayer</code>, 因此导入:</p>
<pre tabindex="0"><code>import &#39;package:audioplayers/audioplayers.dart&#39;;
</code></pre><p>下一步, 我们需要实例变量, 该变量将保存每个BGM对音频播放器的引用:</p>
<pre tabindex="0"><code>AudioPlayer homeBGM;
AudioPlayer playingBGM;
</code></pre><p>在<code>initialize()</code>中的末尾, 我们添加以下代码块初始化这些变量, 暂停播放并播放主页BGM:</p>
<pre tabindex="0"><code>homeBGM = await Flame.audio.loop(&#39;bgm/home.mp3&#39;, volume: .25);
homeBGM.pause();
playingBGM = await Flame.audio.loop(&#39;bgm/playing.mp3&#39;, volume: .25);
playingBGM.pause();

playHomeBGM();
</code></pre>


  <blockquote>
    <p>💡 代码解析: 第一行获取一个<code>AudioPlayer</code>的实例, 该实例加载了传递的文件名. 我们使用<code>loop</code>函数, 因此它将立即开始播放BGM. 我们通过下面的<code>homeBGM.pause()</code>来取消该效果.</p>
<p>你可能会注意到我们将音量设置为0.25, 这是其原始音量的1/4. 若背景音乐声音过大, 将会盖住其他的更重要的东西. 你可以随时使用该值, 有效值为从<code>0</code>(静音)到<code>1</code>(最大音量).</p>
<p>接下来两行做同样的事, 针对于正在播放的BGM.</p>
<p>最后, 我们调用<code>playHomeBGM()</code>(还没开始写)来播放home的BGM</p>
  </blockquote>

<p>🟡 提示: 如果你使用的是新版本的Flame(比如<code>0.11.0</code>), 你会需要使用<code>loopLongAudio</code>来代替<code>loop</code>, 并且替换掉其他需要用到<code>loop</code>的函数.</p>
<p>也欢迎来看一下<a href="https://jap.alekhin.io/scoring-storage-sound-tutorial-flame-flutter-part-4" target="_blank">新的管理及播放背景音乐教程</a>
</p>
<p>现在来写<code>playHomeBGM()</code>:</p>
<pre tabindex="0"><code>void playHomeBGM() {
  playingBGM.pause();
  playingBGM.seek(Duration.zero);
  homeBGM.resume();
}

void playPlayingBGM() {
  homeBGM.pause();
  homeBGM.seek(Duration.zero);
  playingBGM.resume();
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 这两个函数做了类似的事情, 但一种是用于home的BGM, 另一种用于playing的BGM. 它们基本上是对立的.</p>
<p>使用<code>playHomeBGM</code>, 我们暂停<code>playBGM</code>, 并将其播放位置设为从头开始(<code>Duration.zero</code>). 另一方面, <code>playPlayingBGM</code>做了类似的事情, 只是把<code>homeBGM</code>和<code>playBGM</code>进行交换.</p>
  </blockquote>

<p>每当玩家输掉比赛时, 我们都应该返回到<code>homeBGM</code>, 因此在<code>onTapDown</code>处理器和未命中情况下(播放&quot;haha&quot;的SFX下面), 添加以下行用于暂停重置<code>playBGM</code>并播放<code>homeBGM</code>:</p>
<pre tabindex="0"><code>playHomeBGM();
</code></pre><p>然后立刻回到<code>./lib/components/callout.dart</code>, 在游戏失败条件(检查值是否小于0的<code>if</code>块)中, &ldquo;haha&quot;SFX的下方添加:</p>
<pre tabindex="0"><code>fly.game.playHomeBGM();
</code></pre><p>最后一步, 我们要在开始游戏时播放&quot;playing&quot;的BGM, 因此打开<code>./lib/components/start-button.dart</code>, 并在<code>inTapDown</code>函数的末尾添加:</p>
<pre tabindex="0"><code>game.playPlayingBGM();
</code></pre><p>🟢 运行游戏, 听一下我们刚刚加入的背景音乐吧!</p>



  <blockquote>
    <p>🟡 提示: 如果出现音乐播放异常, 先检查代码是否有误.</p>
<p>若保证代码无误, 可以尝试一下清理缓存、重新安装游戏至虚拟机. 有关清理Flutter缓存, 欢迎查看这篇<a href="https://www.bugcatt.com/archives/881" target="_blank">《Flutter 清理编译缓存》</a>
</p>
  </blockquote>

<p><strong>👉在<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/87b114b4e9bed58df986fdfbe0dd64e1fa1fd9e3" target="_blank">Github</a>
或<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/87b114b4e9bed58df986fdfbe0dd64e1fa1fd9e3" target="_blank">码云</a>
上查看这部分的代码.</strong></p>
<h3 id="第五步-控制bgm-和-sfx">第五步: 控制BGM 和 SFX</h3>
<p>游戏中包含音乐和音效通常体验不错, 但我们也需要考虑特殊情况. 有时玩家只想安静的玩游戏🤐🤐.</p>
<p>为此, 我们将为玩家提供两个开关按钮, 一个用于开启/屏蔽音乐, 另一个来开启/屏蔽音效.</p>
<h4 id="开关按钮">开关按钮</h4>
<p>我们将要做的两个按钮分别有两种状态: 启用/禁用. 我们已经在资源包中提供了两种(4个)图片.</p>
<p>让我们将其余的图标从资源包的<code>./images/ui/</code>复制到<code>./assets/images/ui/</code>的assets目录, 文件结构如下:</p>
<pre tabindex="0"><code>./assets
./assets/images
./assets/images/ui
./assets/images/ui/icon-music-disabled.png
./assets/images/ui/icon-music-enabled.png
./assets/images/ui/icon-sound-disabled.png
./assets/images/ui/icon-sound-enabled.png
</code></pre><p>就像其他所有资源文件一样, 我们需要将这些文件添加至<code>./pubspec.yaml</code>的<code>assets</code>中, 使Flutter知道我们需要将这些文件打在包中:</p>
<pre tabindex="0"><code>    - assets/images/ui/icon-music-disabled.png
    - assets/images/ui/icon-music-enabled.png
    - assets/images/ui/icon-sound-disabled.png
    - assets/images/ui/icon-sound-enabled.png
</code></pre>


  <blockquote>
    <p>🔴 注意: 可能是原作者的忙中出错, 检查资源包中的<code>icon-sound enabled.png</code>文件, 若有误则需要重命名为<code>icon-sound-enabled.png</code>!</p>
  </blockquote>

<p>打开<code>./lib/main.dart</code>来预加载这些图标. 在<code>Flame.images.loadAll</code>调用的数组中添加:</p>
<pre tabindex="0"><code>&#39;ui/icon-music-disabled.png&#39;,
&#39;ui/icon-music-enabled.png&#39;,
&#39;ui/icon-sound-disabled.png&#39;,
&#39;ui/icon-sound-enabled.png&#39;,
</code></pre><p>现在, 我们将创建按钮并将其添加到game类中. 这些按钮与&quot;帮助&quot;和&quot;感谢&quot;按钮相似.</p>
<p>创建<code>./lib/components/music-button.dart</code>:</p>
<pre tabindex="0"><code>import &#39;dart:ui&#39;;
import &#39;package:flame/sprite.dart&#39;;
import &#39;package:langaw/langaw-game.dart&#39;;

class MusicButton {
  final LangawGame game;
  Rect rect;
  Sprite enabledSprite;
  Sprite disabledSprite;
  bool isEnabled = true;

  MusicButton(this.game) {
    rect = Rect.fromLTWH(
      game.tileSize * .25,
      game.tileSize * .25,
      game.tileSize,
      game.tileSize,
    );
    enabledSprite = Sprite(&#39;ui/icon-music-enabled.png&#39;);
    disabledSprite = Sprite(&#39;ui/icon-music-disabled.png&#39;);
  }

  void render(Canvas c) {
    if (isEnabled) {
      enabledSprite.renderRect(c, rect);
    } else {
      disabledSprite.renderRect(c, rect);
    }
  }

  void onTapDown() {
    if (isEnabled) {
      isEnabled = false;
      game.homeBGM.setVolume(0);
      game.playingBGM.setVolume(0);
    } else {
      isEnabled = true;
      game.homeBGM.setVolume(.25);
      game.playingBGM.setVolume(.25);
    }
  }
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 由于它和&quot;帮助&quot;以及&quot;感谢&quot;按钮非常相似, 所以重点讲一下它们的不同之处.</p>
<p>我们不是1个<code>sprite</code>变量来存储按钮的sprite. 而是两个, 一个保存启用状态的sprite, 另一个则是禁用状态的sprite. 该按钮在屏幕的左上角, 其左边缘和顶部边缘分别在屏幕的左边和顶部边缘的1/4的位置.</p>
<p>我们还有另一个名为<code>isEnabled</code>的变量, 它是一个布尔值, 表示它可以包含<code>true</code>和<code>false</code>. 通过操纵此变量来切换按钮的状态, 并渲染适当的sprite, 你可以在<code>render()</code>内部看到.</p>
<p>不过, 最重要的区别是<code>onTapDown</code>处理器. 有一个用于检查<code>isEnabled</code>是否为<code>true</code>的<code>if</code>块. 若为<code>true</code>, 则将值改为<code>false</code>, 并且<code>homeBGM</code>和<code>playingBGM</code>的音量(在<code>game</code>实例中)设为0. 若<code>isEnabled</code>为<code>false</code>, 则将值改为<code>true</code>, 并将两个BGM的音量设置为<code>0.25</code>(初始值).</p>
  </blockquote>

<p>让我们来写另一个控制按钮, 创建文件<code>./lib/components/sound-button.dart</code>, :</p>
<pre tabindex="0"><code>import &#39;dart:ui&#39;;
import &#39;package:flame/sprite.dart&#39;;
import &#39;package:langaw/langaw-game.dart&#39;;

class SoundButton {
  final LangawGame game;
  Rect rect;
  Sprite enabledSprite;
  Sprite disabledSprite;
  bool isEnabled = true;

  SoundButton(this.game) {
    rect = Rect.fromLTWH(
      game.tileSize * 1.5,
      game.tileSize * .25,
      game.tileSize,
      game.tileSize,
    );
    enabledSprite = Sprite(&#39;ui/icon-sound-enabled.png&#39;);
    disabledSprite = Sprite(&#39;ui/icon-sound-disabled.png&#39;);
  }

  void render(Canvas c) {
    if (isEnabled) {
      enabledSprite.renderRect(c, rect);
    } else {
      disabledSprite.renderRect(c, rect);
    }
  }

  void onTapDown() {
    isEnabled = !isEnabled;
  }
}
</code></pre>


  <blockquote>
    <p>💡 代码解析: 你应该能注意到, 它几乎和<code>MusicButton</code>完全一致, 其位置在屏幕的左上角, 但位置稍微偏右. 另外, <code>onTapDown</code>处理器只是布尔值的简单切换. 这是因为音效比较短, 无需使它静音.</p>
  </blockquote>

<p>为了将这些按钮显示在游戏中, 我们需要将它们添加至game类中. 打开<code>./lib/langaw-game.dart</code>, 导入刚刚创建的按钮:</p>
<pre tabindex="0"><code>import &#39;package:langaw/components/music-button.dart&#39;;
import &#39;package:langaw/components/sound-button.dart&#39;;
</code></pre><p>然后创建按钮的实例变量:</p>
<pre tabindex="0"><code>MusicButton musicButton;
SoundButton soundButton;
</code></pre><p>我们需要在<code>initialize()</code>中初始化这些按钮, 最好在&quot;帮助&quot;和&quot;感谢&quot;按钮下方:</p>
<pre tabindex="0"><code>musicButton = MusicButton(this);
soundButton = SoundButton(this);
</code></pre><p>接下来我们需要从game类的<code>render()</code>中调用按钮的<code>render()</code>函数. 在最上面显示这些按钮(但在对话框下面), 以便在游戏过程中任何时候都可用(除了&quot;帮助&quot;和&quot;感谢&quot;弹框在屏幕上时):</p>
<pre tabindex="0"><code>musicButton.render(canvas);
soundButton.render(canvas);
</code></pre><p>最后, 我们需要将点击事件转发到按钮的<code>onTapDown</code>处理器. 请记住, 最上面的对象应该首先接收点击事件. 由于我们的按钮将位于弹框的后面, 因此这些按钮的点击判断应在弹框的点击处理器的下方:</p>
<pre tabindex="0"><code>// 音乐按钮
if (!isHandled &amp;&amp; musicButton.rect.contains(d.globalPosition)) {
  musicButton.onTapDown();
  isHandled = true;
}

// 音效按钮
if (!isHandled &amp;&amp; soundButton.rect.contains(d.globalPosition)) {
  soundButton.onTapDown();
  isHandled = true;
}
</code></pre><p><code>MusicButton</code>已经在处理BGM的音量了. 现在唯一缺少的就是让<code>SoundButton</code>的状态影响实际的SFX.</p>
<p>我们要做的是在尝试播放音效之前检查声音按钮的状态. 将&quot;播放&quot;的调用逻辑放在<code>if</code>块中, 就可以实现这个需求, 该块判断<code>soundButton</code>的<code>isEnabled</code>属性是否为<code>true</code>.</p>
<p>我们需要更改三个位置来实现这个功能, 首先打开<code>./lib/langaw-game.dart</code>, <code>onTapDown</code>内部.<br>
替换:</p>
<pre tabindex="0"><code>Flame.audio.play(&#39;sfx/haha&#39; + (rnd.nextInt(5) + 1).toString() + &#39;.ogg&#39;);
</code></pre><p>为:</p>
<pre tabindex="0"><code>if (soundButton.isEnabled) {
  Flame.audio.play(&#39;sfx/haha&#39; + (rnd.nextInt(5) + 1).toString() + &#39;.ogg&#39;);
}
</code></pre><p>第二步, 打开<code>./lib/components/callout.dart</code>, 在<code>update()</code>内部.<br>
替换:</p>
<pre tabindex="0"><code>Flame.audio.play(&#39;sfx/haha&#39; + (fly.game.rnd.nextInt(5) + 1).toString() + &#39;.ogg&#39;);
</code></pre><p>为:</p>
<pre tabindex="0"><code>if (fly.game.soundButton.isEnabled) {
  Flame.audio.play(&#39;sfx/haha&#39; + (fly.game.rnd.nextInt(5) + 1).toString() + &#39;.ogg&#39;);
}
</code></pre><p>最后, 打开<code>./lib/components/fly.dart</code>, 在<code>onTapDown()</code>内部.<br>
替换:</p>
<pre tabindex="0"><code>Flame.audio.play(&#39;sfx/ouch&#39; + (game.rnd.nextInt(11) + 1).toString() + &#39;.ogg&#39;);
</code></pre><p>为</p>
<pre tabindex="0"><code>if (game.soundButton.isEnabled) {
  Flame.audio.play(&#39;sfx/ouch&#39; + (game.rnd.nextInt(11) + 1).toString() + &#39;.ogg&#39;);
}
</code></pre><p><strong>👉在<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/368febc3eeb3adafaf1ff8a5ac400b64ec601f5e" target="_blank">Github</a>
或<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/tree/368febc3eeb3adafaf1ff8a5ac400b64ec601f5e" target="_blank">码云</a>
上查看这部分的代码.</strong></p>
<h3 id="测试游戏">测试游戏!</h3>
<p>如果你一直跟着教程走, 那么现在应该有了一个这样的游戏:</p>
<h3 id="结语">结语</h3>
<p>我们的游戏已经相当完善了: 有了积分系统、高分记录, 音效, BGM和声音控制按钮.</p>
<p>下一章之前, 留给大家一个挑战. 这里有一个小功能大家可以自行研究: 每次玩家启动游戏时, 音乐和音效按钮都会被重置为已启动, 看看你能否把设置状态存起来!</p>
<p>如果你出现了不懂的地方, 不要犹豫, 欢迎在评论区留言! 也欢迎加入<a href="https://jq.qq.com/?_wv=1027&amp;k=5ETLFm3" target="_blank">我的Flame交流群(QQ)</a>
, 进行实时沟通.</p>
<h2 id="下一章会干什么">下一章会干什么</h2>
<p>强烈建议看下一章前, 先来看下<a href="https://jap.alekhin.io/background-music-in-a-flame-game" target="_blank">新的背景音乐教程</a>
</p>
<p>下一章就是终章了! 我们将会修复一些bug, 并将我们的游戏打包, 预备好发布到各大APP平台上!</p>
<h2 id="感谢">感谢</h2>
<ul>
<li>本篇文章参考原作<a href="https://jap.alekhin.io/scoring-storage-sound-tutorial-flame-flutter-part-4" target="_blank">《Scoring, Storage, and Sound Tutorial – Step by Step with Flame and Flutter (Part 4 of 5)》</a>
.</li>
<li>flame <a href="https://github.com/flame-engine/flame" target="_blank">github仓库地址</a>
</li>
<li>pub.dev <a href="https://pub.flutter-io.cn/packages/flame" target="_blank">官方网址</a>
</li>
<li><a href="https://github.com/andyli386" target="_blank">andyli386</a>
的<a href="https://github.com/HarrisonQi/flame-tutorial-langaw/pull/2" target="_blank">PR</a>
</li>
</ul>


        
      </section>

      

      
    </article>
  </div>

  <div class="hidden lg:flex lg:flex-col lg:items-end">
    
  </div>
</div>


            
<footer class="flex justify-between items-center gap-2 px-4 py-12">

  <div>
  
  <p>© 2025 阿航的技术小站</p>
  

  
  <p class="text-sm">
    🌱
    <span class="text-base-content/60">
      Powered by <a class="hover:underline" href="https://gohugo.io/" target="_blank">Hugo</a> with theme
      <a class="hover:underline" href="https://github.com/g1eny0ung/hugo-theme-dream" target="_blank">Dream</a>.</span
    >
  </p>
  
</div>

  <div
  x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }"
  class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"
>
  <template x-for="icon in icons">
    <div
      role="button"
      tabindex="0"
      :aria-label="'Select ' + icon.name + ' mode'"
      class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary"
      :class="$store.darkMode.icon() === icon.name && 'bg-primary'"
      @click="$store.darkMode.toggle(icon.status)"
    >
      <ion-icon
        :name="`${icon.name}-outline`"
        class="group-hover:text-primary-content"
        :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"
      >
      </ion-icon>
    </div>
  </template>
</div>

</footer>

          </div>
        </div>
        <div class="back">
          <div class="container">
            
            <div class="dream-grid dream-grid-about">
  

  

  
</div>

            

            
<footer class="flex justify-between items-center gap-2 px-4 py-12">

  <div>
  
  <p>© 2025 阿航的技术小站</p>
  

  
  <p class="text-sm">
    🌱
    <span class="text-base-content/60">
      Powered by <a class="hover:underline" href="https://gohugo.io/" target="_blank">Hugo</a> with theme
      <a class="hover:underline" href="https://github.com/g1eny0ung/hugo-theme-dream" target="_blank">Dream</a>.</span
    >
  </p>
  
</div>

  <div
  x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }"
  class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"
>
  <template x-for="icon in icons">
    <div
      role="button"
      tabindex="0"
      :aria-label="'Select ' + icon.name + ' mode'"
      class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary"
      :class="$store.darkMode.icon() === icon.name && 'bg-primary'"
      @click="$store.darkMode.toggle(icon.status)"
    >
      <ion-icon
        :name="`${icon.name}-outline`"
        class="group-hover:text-primary-content"
        :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"
      >
      </ion-icon>
    </div>
  </template>
</div>

</footer>

          </div>
        </div>
      </div>
    </div>

    <script>
  window.lightTheme =  null 
  window.darkTheme =  null 
</script>


  <script src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>

  
  
  <script src="/js/grid.js"></script>




<script src="/js/main.js"></script>

    









    

    

    

    

    <script type="module" src="https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.4.0/dist/ionicons/ionicons.js"></script>
  </body>
</html>
